//shared section for the tenant manager and the grid manager

== What is cross-grid replication?

Cross-grid replication is the automatic replication of objects between selected S3 buckets in two StorageGRID systems that are connected in a xref:../admin/grid-federation-overview.adoc[grid federation connection].

=== Requirements for cross-grid replication

If a tenant account has the *Use grid federation connection* permission, a tenant user with Root Access permission can create identical buckets in the corresponding tenant accounts on each grid. These buckets:

* Must have the same name and region
* Must have versioning enabled
* Must have S3 Object Lock disabled
* Must be empty

After both buckets have been created, cross-grid replication can be configured to occur in one direction or in both directions.

==== [[replication-one-direction]]Replication in one direction

If you enable cross-grid replication for a bucket on only one grid, objects added to the source bucket are replicated to the destination bucket, but objects added to the destination bucket are not replicated back to the source. In the figure, cross-grid replication is enabled for `my-bucket` from Grid 1 to Grid 2, but it is not enabled in the other direction. 

image:../media/grid-federation-cross-grid-replication-one-direction.png[image showing grid federation connection in one direction]

==== [[replication-both-directions]]Replication in both directions
If you enable cross-grid replication for the same bucket on both grids, objects added to either bucket are replicated to the other grid. In the figure, cross-grid replication is enabled for `my-bucket` in both directions. 

image:../media/grid-federation-cross-grid-replication.png[image showing replication in one direction vs replication in both directions]

=== [[client-writes]]What happens when objects are added?

When an S3 client adds an object to a bucket that has cross-grid replication enabled, that object version is immediately replicated from the source bucket to the destination bucket. The object is then stored according to the matching ILM rule in each grid's active ILM policy. For example, object A on grid 1 might be stored as two replicated copies and retained forever, while the copy of object A that was replicated to grid 2 might be stored using 2+1 erasure coding and deleted after three years. 

=== [[client-deletes]]What happens when objects are deleted?

To understand what happens when an S3 client deletes objects from a bucket that has cross-grid replication enabled, start by reviewing how S3 clients delete objects from buckets that have versioning enabled, as follows:

* If an S3 client issues a delete request that includes a version ID, that version of the object is permanently removed. No delete marker is added the bucket. 

* If an S3 client issues a delete request that does not include a version ID, StorageGRID does not delete any object versions. Instead, it adds a delete marker to the bucket. The delete marker causes StorageGRID to behave as if the object was deleted:

** A GET request without a version ID will fail with `404 No Object Found`
** A GET request with a valid version ID will succeed and return the requested object version.

When you enable cross-grid replication for a bucket, you can specify what happens when S3 clients issue a delete request that does not include a version ID:

* If you choose to replicate delete markers, a delete marker is added to the source bucket and replicated to the destination bucket. In effect, the objects appear to be deleted on both grids.

*  If you choose not to replicate delete markers, a delete marker is added to the source bucket, but it is not replicated to the destination bucket. In effect, objects that the client deletes on the source grid are not deleted on the destination grid.

IMPORTANT: The option to replicate client delete markers does not affect delete object requests that include a version ID. When you include a version ID, objects are permanently removed from the source grid. However, these requests are never replicated to the destination grid because they do not add delete markers to the bucket. 

In the figure, the grids are configured for cross-grid replication in both directions, but delete markers are not replicated from `my-bucket` on Grid 1 to `my-bucket` on Grid 2.

image:../media/grid-federation-cross-grid-replication-delete.png[image showing replicate client delete on both grids]

=== How does cross-grid replication work with encrypted objects?
When using cross-grid replication to replicate objects between grids, you can encrypt individual objects, use default bucket encryption, or configure grid-wide encryption. You can add, modify, or remove encryption settings before or after you enable cross-grid replication for a bucket.

To encrypt individual objects, you can use SSE (server-side encryption with StorageGRID-managed keys) when adding the objects to the source bucket. Use the `x-amz-server-side-encryption` request header and specify `AES256`. See xref:../s3/using-server-side-encryption.adoc[Use server-side encryption]. 

NOTE: Using SSE-C (server-side encryption with customer-provided keys) is not supported for cross-grid replication. The ingest operation will fail.

To use default encryption for a bucket, use a PUT bucket encryption request and set the `SSEAlgorithm` parameter to `AES256`. See xref:../s3/operations-on-buckets.adoc[Operations on buckets]. This option encrypts any objects that are not encrypted at the object level during ingest.

To use grid-level encryption, set the *Stored object encryption* option to *AES-256*. This option encrypts any objects that are not encrypted at the bucket level or at the object level during ingest. See xref:..admin/changing-network-options-object-encryption.adoc[Configure network and object options].

NOTE: SSE does not support AES128. If *Stored object encryption* option is enabled for the source grid using the *AES-128* option, objects replicated to the destination grid will not be encrypted.

When encryption is enabled, StorageGRID uses these rules to determine whether to encrypt the replicated objects at the destination:

* If a source object uses SSE, the object replicated to the destination bucket will also use SSE.  
* If a source object does not use SSE, the object replicated to the destination bucket will not be encrypted, unless the destination bucket or grid has encryption configured. In that case, the destination bucket or grid's default encryption is applied to the replicated object.

* If the *Stored object encryption* option is enabled for the source grid using the *AES-256* option, objects replicated to the destination grid will also be encrypted.

* If the *Stored object encryption* option is enabled only for the destination grid, objects replicated to the destination will be encrypted.







